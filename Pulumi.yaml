name: actions-aws-webserver
runtime: yaml
config:
  cpu:
    value: 256
    secret: false
  memory:
    value: 512
    secret: false
  image: 
    value: grafana/grafana
    secret: false
  port: 
    value: 3000
    secret: false
resources:
  lb:
    type: awsx:lb:ApplicationLoadBalancer
    properties:
      
      defaultTargetGroup:
        connectionTermination: false
        deregistrationDelay: 0
        port: ${port}
        healthCheck:
            enabled: true
            healthyThreshold: 5
            interval: 30
            matcher: "200"
            path: /api/health
  cluster:
    type: aws:ecs:Cluster
  
  service:
    type: awsx:ecs:FargateService
    properties:
      cluster: ${cluster.arn}
      assignPublicIp: true
      
      taskDefinitionArgs:
        container:
          name: service
          image: ${image}
          cpu: ${cpu}
          memory: ${memory}
          essential: true
          portMappings:
            - containerPort: ${port}
              hostPort: ${port}
              targetGroup: ${lb.defaultTargetGroup}
outputs:
  url: http://${lb.loadBalancer.dnsName}